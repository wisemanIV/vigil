(()=>{"use strict";const e=class{constructor(e){this.onFileSelect=e,this.originalInputs=new WeakMap,this.blockedFiles=new Set,this.observer=null}initialize(){console.log("[DLP Upload Monitor] Initializing..."),this.waitForBody().then(()=>{this.startMonitoring()})}waitForBody(){return new Promise(e=>{if(document.body)return void e();const o=new MutationObserver(()=>{document.body&&(o.disconnect(),e())});o.observe(document.documentElement,{childList:!0,subtree:!0})})}startMonitoring(){console.log("[DLP Upload Monitor] Starting monitoring...");try{this.monitorExistingInputs(),this.observeDOMChanges(),this.monitorDragAndDrop(),this.monitorHiddenInputs(),console.log("[DLP Upload Monitor] Monitoring active")}catch(e){console.error("[DLP Upload Monitor] Failed to start monitoring:",e)}}monitorExistingInputs(){try{const e=document.querySelectorAll('input[type="file"]');console.log(`[DLP Upload Monitor] Found ${e.length} file inputs`),e.forEach(e=>this.attachToInput(e))}catch(e){console.error("[DLP Upload Monitor] Error monitoring existing inputs:",e)}}observeDOMChanges(){try{if(!document.body)return void console.warn("[DLP Upload Monitor] Body not available for observation");this.observer=new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{if(1===e.nodeType&&("INPUT"===e.tagName&&"file"===e.type&&(console.log("[DLP Upload Monitor] New file input detected"),this.attachToInput(e)),e.querySelectorAll)){const o=e.querySelectorAll('input[type="file"]');o.length>0&&(console.log(`[DLP Upload Monitor] Found ${o.length} file inputs in added node`),o.forEach(e=>this.attachToInput(e)))}})})}),this.observer.observe(document.body,{childList:!0,subtree:!0}),console.log("[DLP Upload Monitor] DOM mutation observer active")}catch(e){console.error("[DLP Upload Monitor] Error setting up DOM observer:",e)}}monitorHiddenInputs(){setInterval(()=>{try{document.querySelectorAll('input[type="file"]').forEach(e=>{this.originalInputs.has(e)||(console.log("[DLP Upload Monitor] Found previously unmonitored input"),this.attachToInput(e))})}catch(e){console.error("[DLP Upload Monitor] Error in periodic check:",e)}},2e3)}attachToInput(e){if(!this.originalInputs.has(e))try{console.log("[DLP Upload Monitor] Attaching to input:",{id:e.id,className:e.className,accept:e.accept,multiple:e.multiple}),this.originalInputs.set(e,!0),e.addEventListener("change",async o=>{console.log("[DLP Upload Monitor] Change event triggered"),await this.handleFileSelection(o,e)},!0),this.addVisualIndicator(e)}catch(e){console.error("[DLP Upload Monitor] Error attaching to input:",e)}}async handleFileSelection(e,o){const t=Array.from(o.files||[]);if(0!==t.length){console.log("[DLP Upload Monitor] Files selected:",t.map(e=>({name:e.name,type:e.type,size:e.size}))),e.preventDefault(),e.stopPropagation(),this.showNotification("üîç Scanning uploaded files...","#4285f4");try{const e=[];for(const o of t){console.log("[DLP Upload Monitor] Analyzing file:",o.name);const t=await this.onFileSelect(o);e.push({file:o,result:t})}const n=e.filter(e=>!e.result.allowed);if(n.length>0){console.warn("[DLP Upload Monitor] Files blocked:",n),o.value="";const e=n.map(e=>e.file.name).join(", "),t=n[0].result.reason;return this.showNotification(`üõ°Ô∏è Upload blocked: ${e}\nReason: ${t}`,"#ea4335",7e3),!1}return console.log("[DLP Upload Monitor] All files approved"),this.showNotification(`‚úì ${t.length} file(s) approved`,"#34a853",3e3),!0}catch(e){return console.error("[DLP Upload Monitor] Analysis failed:",e),o.value="",this.showNotification("‚ö†Ô∏è Upload blocked: Analysis error","#ea4335",5e3),!1}}else console.log("[DLP Upload Monitor] No files selected")}monitorDragAndDrop(){try{document.addEventListener("drop",async e=>{const o=Array.from(e.dataTransfer?.files||[]);if(0===o.length)return;console.log("[DLP Upload Monitor] Files dropped:",o.map(e=>e.name)),e.preventDefault(),e.stopPropagation(),this.showNotification("üîç Scanning dropped files...","#4285f4");const t=[];for(const e of o){const o=await this.onFileSelect(e);t.push({file:e,result:o})}const n=t.filter(e=>!e.result.allowed);if(n.length>0){const e=n.map(e=>e.file.name).join(", ");return this.showNotification(`üõ°Ô∏è Drop blocked: ${e}`,"#ea4335",5e3),!1}this.showNotification(`‚úì ${o.length} file(s) approved`,"#34a853",3e3)},!0),document.addEventListener("dragover",e=>{e.dataTransfer?.types.includes("Files")&&e.preventDefault()},!0),console.log("[DLP Upload Monitor] Drag and drop monitoring active")}catch(e){console.error("[DLP Upload Monitor] Error setting up drag and drop:",e)}}addVisualIndicator(e){try{if(e.dataset.dlpMonitored)return;e.dataset.dlpMonitored="true";const o=document.createElement("span");o.textContent="üõ°Ô∏è",o.title="DLP Protection Active",o.style.cssText="\n                position: absolute;\n                margin-left: -25px;\n                margin-top: 5px;\n                font-size: 14px;\n                opacity: 0.7;\n                pointer-events: none;\n            ",e.parentNode&&e.parentNode.insertBefore(o,e)}catch(e){}}showNotification(e,o,t=3e3){try{const n=document.getElementById("dlp-upload-notification");n&&n.remove();const i=document.createElement("div");i.id="dlp-upload-notification",i.style.cssText=`\n                position: fixed;\n                top: 80px;\n                right: 20px;\n                background: ${o};\n                color: white;\n                padding: 16px 24px;\n                border-radius: 8px;\n                font-family: -apple-system, BlinkMacSystemFont, sans-serif;\n                font-size: 14px;\n                font-weight: 500;\n                z-index: 2147483647;\n                box-shadow: 0 4px 12px rgba(0,0,0,0.2);\n                max-width: 400px;\n                white-space: pre-line;\n            `,i.textContent=e,document.body&&(document.body.appendChild(i),setTimeout(()=>{i.parentNode&&i.remove()},t))}catch(e){console.error("[DLP Upload Monitor] Error showing notification:",e)}}cleanup(){this.observer&&this.observer.disconnect()}};!function(){console.log("[DLP] Content script loaded on:",window.location.href);let o=!1,t=null;function n(){console.log("[DLP] Initializing upload monitor...");try{t=new e(i),t.initialize(),console.log("[DLP] Upload monitor initialized successfully")}catch(e){console.error("[DLP] Failed to initialize upload monitor:",e)}}async function i(e){console.log("[DLP] File upload detected:",e.name,e.type,e.size);try{const o=await chrome.runtime.sendMessage({action:"analyzeFile",file:{name:e.name,type:e.type,size:e.size,lastModified:e.lastModified},fileData:await e.arrayBuffer(),context:{url:window.location.href,domain:window.location.hostname}});return console.log("[DLP] File analysis result:",o),o}catch(e){return console.error("[DLP] File analysis failed:",e),{allowed:!1,reason:"Analysis error",error:e.message}}}function a(e,o,t){const n=document.getElementById("dlp-notification");n&&n.remove();const i=document.createElement("div");i.id="dlp-notification",i.textContent=e,i.style.cssText=`\n            position: fixed; top: 20px; right: 20px;\n            background: ${o}; color: white;\n            padding: 12px 24px; border-radius: 8px;\n            font-family: -apple-system, BlinkMacSystemFont, sans-serif;\n            font-size: 14px; font-weight: 500;\n            z-index: 2147483647;\n            box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n        `,document.body.appendChild(i),setTimeout(()=>i.remove(),t)}chrome.runtime.sendMessage({action:"getStatus"},e=>{o=e?.ready||!1,console.log("[DLP] Analyzer status:",o?"Ready":"Initializing..."),o?n():(console.log("[DLP] Waiting for analyzer to be ready..."),setTimeout(()=>{chrome.runtime.sendMessage({action:"getStatus"},e=>{e?.ready&&n()})},3e3))}),document.addEventListener("paste",async function(e){const o=e.clipboardData?.getData("text");if(o&&0!==o.trim().length){console.log("[DLP] Paste detected, length:",o.length),e.preventDefault(),e.stopPropagation(),a("üîç Analyzing paste...","#4285f4",1e4);try{const t=await chrome.runtime.sendMessage({action:"analyzePaste",content:o,context:{url:window.location.href,domain:window.location.hostname,elementType:e.target.tagName}});console.log("[DLP] Paste analysis result:",t),t.allowed?(function(e,o){if(e.isContentEditable)document.execCommand("insertText",!1,o);else if("TEXTAREA"===e.tagName||"INPUT"===e.tagName){const t=e.selectionStart,n=e.selectionEnd,i=e.value;e.value=i.substring(0,t)+o+i.substring(n),e.selectionStart=e.selectionEnd=t+o.length,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0}))}}(e.target,o),a("‚úì Paste allowed","#34a853",2e3)):a(`üõ°Ô∏è Blocked: ${t.reason}`,"#ea4335",5e3)}catch(e){console.error("[DLP] Paste analysis failed:",e),a("‚ö†Ô∏è Paste blocked: Error","#ea4335",3e3)}}},!0)}()})();