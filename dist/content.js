(()=>{"use strict";const e=class{constructor(e){this.onFileSelect=e,this.originalInputs=new WeakMap,this.blockedFiles=new Set,this.observer=null}initialize(){console.log("[DLP Upload Monitor] Initializing..."),this.waitForBody().then(()=>{this.startMonitoring()})}waitForBody(){return new Promise(e=>{if(document.body)return void e();const t=new MutationObserver(()=>{document.body&&(t.disconnect(),e())});t.observe(document.documentElement,{childList:!0,subtree:!0})})}startMonitoring(){console.log("[DLP Upload Monitor] Starting monitoring...");try{this.monitorExistingInputs(),this.observeDOMChanges(),this.monitorDragAndDrop(),this.monitorHiddenInputs(),console.log("[DLP Upload Monitor] Monitoring active")}catch(e){console.error("[DLP Upload Monitor] Failed to start monitoring:",e)}}monitorExistingInputs(){try{const e=document.querySelectorAll('input[type="file"]');console.log(`[DLP Upload Monitor] Found ${e.length} file inputs`),e.forEach(e=>this.attachToInput(e))}catch(e){console.error("[DLP Upload Monitor] Error monitoring existing inputs:",e)}}observeDOMChanges(){try{if(!document.body)return void console.warn("[DLP Upload Monitor] Body not available for observation");this.observer=new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{if(1===e.nodeType&&("INPUT"===e.tagName&&"file"===e.type&&(console.log("[DLP Upload Monitor] New file input detected"),this.attachToInput(e)),e.querySelectorAll)){const t=e.querySelectorAll('input[type="file"]');t.length>0&&(console.log(`[DLP Upload Monitor] Found ${t.length} file inputs in added node`),t.forEach(e=>this.attachToInput(e)))}})})}),this.observer.observe(document.body,{childList:!0,subtree:!0}),console.log("[DLP Upload Monitor] DOM mutation observer active")}catch(e){console.error("[DLP Upload Monitor] Error setting up DOM observer:",e)}}monitorHiddenInputs(){setInterval(()=>{try{document.querySelectorAll('input[type="file"]').forEach(e=>{this.originalInputs.has(e)||(console.log("[DLP Upload Monitor] Found previously unmonitored input"),this.attachToInput(e))})}catch(e){console.error("[DLP Upload Monitor] Error in periodic check:",e)}},2e3)}attachToInput(e){if(!this.originalInputs.has(e))try{console.log("[DLP Upload Monitor] Attaching to input:",{id:e.id,className:e.className,accept:e.accept,multiple:e.multiple}),this.originalInputs.set(e,!0),e.addEventListener("change",async t=>{console.log("[DLP Upload Monitor] Change event triggered"),await this.handleFileSelection(t,e)},!0),this.addVisualIndicator(e)}catch(e){console.error("[DLP Upload Monitor] Error attaching to input:",e)}}async handleFileSelection(e,t){const n=Array.from(t.files||[]);if(0!==n.length){console.log("[DLP Upload Monitor] Files selected:",n.map(e=>({name:e.name,type:e.type,size:e.size}))),e.preventDefault(),e.stopPropagation(),this.showNotification("üîç Scanning uploaded files...","#4285f4");try{const e=[];for(const t of n){console.log("[DLP Upload Monitor] Analyzing file:",t.name);const n=await this.onFileSelect(t);e.push({file:t,result:n})}const o=e.filter(e=>!e.result.allowed);if(o.length>0){console.warn("[DLP Upload Monitor] Files blocked:",o),t.value="";const e=o.map(e=>e.file.name).join(", "),n=o[0].result.reason;return this.showNotification(`üõ°Ô∏è Upload blocked: ${e}\nReason: ${n}`,"#ea4335",7e3),!1}return console.log("[DLP Upload Monitor] All files approved"),this.showNotification(`‚úì ${n.length} file(s) approved`,"#34a853",3e3),!0}catch(e){return console.error("[DLP Upload Monitor] Analysis failed:",e),t.value="",this.showNotification("‚ö†Ô∏è Upload blocked: Analysis error","#ea4335",5e3),!1}}else console.log("[DLP Upload Monitor] No files selected")}monitorDragAndDrop(){try{document.addEventListener("drop",async e=>{const t=Array.from(e.dataTransfer?.files||[]);if(0===t.length)return;console.log("[DLP Upload Monitor] Files dropped:",t.map(e=>e.name)),e.preventDefault(),e.stopPropagation(),this.showNotification("üîç Scanning dropped files...","#4285f4");const n=[];for(const e of t){const t=await this.onFileSelect(e);n.push({file:e,result:t})}const o=n.filter(e=>!e.result.allowed);if(o.length>0){const e=o.map(e=>e.file.name).join(", ");return this.showNotification(`üõ°Ô∏è Drop blocked: ${e}`,"#ea4335",5e3),!1}this.showNotification(`‚úì ${t.length} file(s) approved`,"#34a853",3e3)},!0),document.addEventListener("dragover",e=>{e.dataTransfer?.types.includes("Files")&&e.preventDefault()},!0),console.log("[DLP Upload Monitor] Drag and drop monitoring active")}catch(e){console.error("[DLP Upload Monitor] Error setting up drag and drop:",e)}}addVisualIndicator(e){try{if(e.dataset.dlpMonitored)return;e.dataset.dlpMonitored="true";const t=document.createElement("span");t.textContent="üõ°Ô∏è",t.title="DLP Protection Active",t.style.cssText="\n                position: absolute;\n                margin-left: -25px;\n                margin-top: 5px;\n                font-size: 14px;\n                opacity: 0.7;\n                pointer-events: none;\n            ",e.parentNode&&e.parentNode.insertBefore(t,e)}catch(e){}}showNotification(e,t,n=3e3){try{const o=document.getElementById("dlp-upload-notification");o&&o.remove();const i=document.createElement("div");i.id="dlp-upload-notification",i.style.cssText=`\n                position: fixed;\n                top: 80px;\n                right: 20px;\n                background: ${t};\n                color: white;\n                padding: 16px 24px;\n                border-radius: 8px;\n                font-family: -apple-system, BlinkMacSystemFont, sans-serif;\n                font-size: 14px;\n                font-weight: 500;\n                z-index: 2147483647;\n                box-shadow: 0 4px 12px rgba(0,0,0,0.2);\n                max-width: 400px;\n                white-space: pre-line;\n            `,i.textContent=e,document.body&&(document.body.appendChild(i),setTimeout(()=>{i.parentNode&&i.remove()},n))}catch(e){console.error("[DLP Upload Monitor] Error showing notification:",e)}}cleanup(){this.observer&&this.observer.disconnect()}},t=class{constructor(e){this.onScreenshotAttempt=e,this.sensitiveElements=[],this.isBlurring=!1,this.settings={enabled:!0,autoBlur:!0,logAttempts:!0}}async initialize(){console.log("[Screenshot Monitor] Initializing..."),await this.loadSettings(),this.settings.enabled?(this.monitorKeyboardShortcuts(),this.monitorClipboard(),this.startContentScanning(),console.log("[Screenshot Monitor] Active")):console.log("[Screenshot Monitor] Disabled in settings")}async loadSettings(){return new Promise(e=>{chrome.storage.local.get(["screenshotProtection"],t=>{t.screenshotProtection&&(this.settings={...this.settings,...t.screenshotProtection}),e()})})}monitorKeyboardShortcuts(){document.addEventListener("keydown",async e=>{const t=(e.ctrlKey||e.metaKey)&&e.shiftKey&&("S"===e.key||"s"===e.key),n="PrintScreen"===e.key,o=e.shiftKey&&"Windows"===e.key&&"s"===e.key,i=e.metaKey&&e.shiftKey&&["3","4","5"].includes(e.key);(t||n||o||i)&&(console.log("[Screenshot Monitor] Screenshot shortcut detected:",e.key),await this.handleScreenshotAttempt("keyboard",e.key))},!0)}monitorClipboard(){document.addEventListener("paste",async e=>{const t=e.clipboardData?.items;if(t)for(const e of t)e.type.startsWith("image/")&&(console.log("[Screenshot Monitor] Image in clipboard detected"),await this.handleScreenshotAttempt("clipboard","paste"))},!0),document.addEventListener("copy",async e=>{const t=window.getSelection();t&&t.toString().length>0&&await this.checkCopiedContent(t.toString())},!0)}startContentScanning(){this.scanInterval=setInterval(()=>{this.scanVisibleContent()},2e3),setTimeout(()=>this.scanVisibleContent(),1e3)}async scanVisibleContent(){try{const e=this.extractVisibleText(),t=await chrome.runtime.sendMessage({action:"analyzePaste",content:e,context:{url:window.location.href,domain:window.location.hostname,type:"screenshot_scan"}});!t.allowed&&t.findings&&t.findings.length>0?this.markSensitiveContent(t.findings):this.clearSensitiveMarkings()}catch(e){console.error("[Screenshot Monitor] Scan failed:",e)}}extractVisibleText(){const e=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:e=>{const t=e.parentElement;if(!t)return NodeFilter.FILTER_REJECT;const n=window.getComputedStyle(t);if("none"===n.display||"hidden"===n.visibility||"0"===n.opacity)return NodeFilter.FILTER_REJECT;const o=t.getBoundingClientRect();return o.bottom<0||o.top>window.innerHeight||o.right<0||o.left>window.innerWidth?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}});let t,n="";for(;t=e.nextNode();)n+=t.textContent+" ";return n.substring(0,1e4)}markSensitiveContent(e){this.sensitiveElements=[],e.forEach(e=>{this.findElementsWithContent(e).forEach(e=>{this.sensitiveElements.includes(e)||(this.sensitiveElements.push(e),e.dataset.vigilSensitive="true")})}),console.log(`[Screenshot Monitor] Marked ${this.sensitiveElements.length} sensitive elements`)}findElementsWithContent(e){const t=[],n="//text()[contains(., '"+(e.sample?.[0]||e.type)+"')]/..";try{const e=document.evaluate(n,document,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);for(let n=0;n<Math.min(e.snapshotLength,10);n++)t.push(e.snapshotItem(n))}catch(n){const o=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT);let i;for(;(i=o.nextNode())&&!(e.sample&&e.sample.some(e=>i.textContent.includes(e))&&(t.push(i.parentElement),t.length>=10)););}return t}clearSensitiveMarkings(){this.sensitiveElements.forEach(e=>{delete e.dataset.vigilSensitive}),this.sensitiveElements=[]}async handleScreenshotAttempt(e,t){console.log(`[Screenshot Monitor] Attempt detected: ${e} - ${t}`);const n=this.sensitiveElements.length>0;n&&(this.settings.autoBlur?(this.blurSensitiveContent(),this.showWarning("‚ö†Ô∏è Screenshot Blocked",`Sensitive data detected on screen. ${this.sensitiveElements.length} area(s) temporarily blurred.`,5e3),setTimeout(()=>{this.unblurSensitiveContent()},3e3)):this.showWarning("‚ö†Ô∏è Screenshot Warning","Sensitive data is visible on this page. Screenshot contains protected information.",5e3)),this.settings.logAttempts&&await this.logScreenshotAttempt(e,t,n),this.onScreenshotAttempt&&this.onScreenshotAttempt({method:e,key:t,hasSensitiveData:n,elementCount:this.sensitiveElements.length,timestamp:Date.now()})}blurSensitiveContent(){this.isBlurring||(this.isBlurring=!0,console.log(`[Screenshot Monitor] Blurring ${this.sensitiveElements.length} elements`),this.sensitiveElements.forEach(e=>{e.dataset.vigilOriginalFilter=e.style.filter||"",e.style.filter="blur(10px)",e.style.transition="filter 0.2s",e.style.outline="2px solid rgba(234, 67, 53, 0.5)"}))}unblurSensitiveContent(){this.isBlurring&&(this.isBlurring=!1,console.log("[Screenshot Monitor] Removing blur"),this.sensitiveElements.forEach(e=>{e.style.filter=e.dataset.vigilOriginalFilter||"",delete e.dataset.vigilOriginalFilter,e.style.outline=""}))}async logScreenshotAttempt(e,t,n){try{await chrome.runtime.sendMessage({action:"logScreenshot",data:{method:e,key:t,hasSensitiveData:n,elementCount:this.sensitiveElements.length,url:window.location.href,timestamp:Date.now()}})}catch(e){console.error("[Screenshot Monitor] Failed to log:",e)}}async checkCopiedContent(e){try{const t=await chrome.runtime.sendMessage({action:"analyzePaste",content:e,context:{url:window.location.href,domain:window.location.hostname,type:"copy"}});t.allowed||this.showWarning("‚ö†Ô∏è Sensitive Data Copied",`You copied: ${t.reason}`,4e3)}catch(e){console.error("[Screenshot Monitor] Copy check failed:",e)}}showWarning(e,t,n){const o=document.getElementById("vigil-screenshot-warning");o&&o.remove();const i=document.createElement("div");i.id="vigil-screenshot-warning",i.style.cssText="\n            position: fixed;\n            top: 50%;\n            left: 50%;\n            transform: translate(-50%, -50%);\n            background: rgba(234, 67, 53, 0.95);\n            color: white;\n            padding: 24px 32px;\n            border-radius: 12px;\n            font-family: -apple-system, BlinkMacSystemFont, sans-serif;\n            font-size: 16px;\n            font-weight: 500;\n            z-index: 2147483647;\n            box-shadow: 0 8px 32px rgba(0,0,0,0.3);\n            max-width: 500px;\n            text-align: center;\n            animation: vigilPulse 0.5s ease-out;\n        ",i.innerHTML=`\n            <div style="font-size: 32px; margin-bottom: 12px;">${e.split(" ")[0]}</div>\n            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">\n                ${e.split(" ").slice(1).join(" ")}\n            </div>\n            <div style="font-size: 14px; opacity: 0.9;">\n                ${t}\n            </div>\n        `;const s=document.createElement("style");s.textContent="\n            @keyframes vigilPulse {\n                0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }\n                50% { transform: translate(-50%, -50%) scale(1.05); }\n                100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }\n            }\n        ",document.head.appendChild(s),document.body.appendChild(i),setTimeout(()=>{i.style.transition="opacity 0.3s",i.style.opacity="0",setTimeout(()=>i.remove(),300)},n)}cleanup(){this.scanInterval&&clearInterval(this.scanInterval),this.clearSensitiveMarkings()}};!function(){console.log("[DLP] Content script loaded on:",window.location.href);let n=!1,o=null,i=null;function s(){console.log("[DLP] Initializing monitors...");try{o=new e(r),o.initialize()}catch(e){console.error("[DLP] Failed to initialize upload monitor:",e)}try{i=new t(a),i.initialize()}catch(e){console.error("[DLP] Failed to initialize screenshot monitor:",e)}}function a(e){console.log("[DLP] Screenshot attempt:",e)}async function r(e){console.log("[DLP] File upload detected:",e.name,e.type,e.size);try{const t=await chrome.runtime.sendMessage({action:"analyzeFile",file:{name:e.name,type:e.type,size:e.size,lastModified:e.lastModified},fileData:await e.arrayBuffer(),context:{url:window.location.href,domain:window.location.hostname}});return console.log("[DLP] File analysis result:",t),t}catch(e){return console.error("[DLP] File analysis failed:",e),{allowed:!1,reason:"Analysis error",error:e.message}}}function l(e,t,n){const o=document.getElementById("dlp-notification");o&&o.remove();const i=document.createElement("div");i.id="dlp-notification",i.textContent=e,i.style.cssText=`\n            position: fixed; top: 20px; right: 20px;\n            background: ${t}; color: white;\n            padding: 12px 24px; border-radius: 8px;\n            font-family: -apple-system, BlinkMacSystemFont, sans-serif;\n            font-size: 14px; font-weight: 500;\n            z-index: 2147483647;\n            box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n        `,document.body.appendChild(i),setTimeout(()=>i.remove(),n)}chrome.runtime.sendMessage({action:"getStatus"},e=>{n=e?.ready||!1,console.log("[DLP] Analyzer status:",n?"Ready":"Initializing..."),n?s():setTimeout(()=>{chrome.runtime.sendMessage({action:"getStatus"},e=>{e?.ready&&s()})},3e3)}),document.addEventListener("paste",async function(e){const t=e.clipboardData?.getData("text");if(t&&0!==t.trim().length){console.log("[DLP] Paste detected, length:",t.length),e.preventDefault(),e.stopPropagation(),l("üîç Analyzing paste...","#4285f4",1e4);try{const n=await chrome.runtime.sendMessage({action:"analyzePaste",content:t,context:{url:window.location.href,domain:window.location.hostname,elementType:e.target.tagName}});console.log("[DLP] Paste analysis result:",n),n.allowed?(function(e,t){if(e.isContentEditable)document.execCommand("insertText",!1,t);else if("TEXTAREA"===e.tagName||"INPUT"===e.tagName){const n=e.selectionStart,o=e.selectionEnd,i=e.value;e.value=i.substring(0,n)+t+i.substring(o),e.selectionStart=e.selectionEnd=n+t.length,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0}))}}(e.target,t),l("‚úì Paste allowed","#34a853",2e3)):l(`üõ°Ô∏è Blocked: ${n.reason}`,"#ea4335",5e3)}catch(e){console.error("[DLP] Paste analysis failed:",e),l("‚ö†Ô∏è Paste blocked: Error","#ea4335",3e3)}}},!0),window.addEventListener("beforeunload",()=>{i&&i.cleanup()})}()})();